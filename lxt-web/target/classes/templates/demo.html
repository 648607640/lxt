<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>百度离线版DEMO</title>
<script type="text/javascript" src="js/apiv1.3.min.js"></script>
<!-- <script type="text/javascript" src="http://api.map.baidu.com/api?v=1.3"></script> -->
<script type="text/javascript" src="js/jquery.min.js"></script>
<script type="text/javascript" src="js/Messenger.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<link rel="stylesheet" type="text/css" href="css/bmap.css"/>
<style type="text/css">
			.position-box .points{
				margin:0;
				padding-left:0;
				list-style: none;
			}
			.position-box .point{
				position:relative;
				margin-top: 20px;
				padding:5px 5px 5px 30px;
			}
			.position-box .point.active{
				background-color:#d9edf7;
				border-radius: 4px;
			}
			.position-box .point .icon{
				position:absolute;
				left:5px;
				top:5px;
				display:block;
				width:22px;
				height:25px;
				background:url(images/markers.png);
			}
			.position-box .point .name{
				font-size:16px;
				color:blue;
			}
			.position-box .point .item{
				line-height:24px;
				font-size:14px;
				color:#888;
			}
		</style>
</head>
<body>
	<table style="width:100%;height:500px;">
		<tr>
			<td style="position:relative;vertical-align: top;">
				<div style="padding:5px 0 5px 5px;background:white;position:absolute;z-index:99999;top:10px;left:9.3%;width:80%;border:1px solid #ddd;">
					<table style="width:100%;">
						<tr>
							<td>
								<input id="searchInput" type="text" style="padding:8px;width:100%;" placeholder="请输入营业厅或地址">
							</td>
							<td style="width:85px;text-align: right;">
								<button id="searchBtn" style="margin-right:5px;padding:5px 10px;font-size:16px;">搜索</button>
							</td>
						</tr>
					</table>
				</div>
				<div id="container" style="border:1px solid gray;height:500px;"></div>
			</td>
			<td class="position-box" style="width:300px;height:400px;vertical-align: top;">
				<div style="border:1px solid #ddd;padding:10px;">
					<div style="height:20px;line-height:20px;border-left:4px solid red;padding-left:5px;">当前位置</div>
					<div style="font-size:14px;color:#888;padding:5px 0 5px 10px;">长宁区长宁路1033号(长宁路营业厅)</div>
				</div>

				<div style="position:relative;height:400px;overflow-y:auto;border:1px solid #ddd;margin-top:8px;padding:10px;">
					<div style="height:20px;line-height:20px;border-left:4px solid red;padding-left:5px;">附近网点</div>
					<ul class="points">

					</ul>
				</div>
			</td>
		</tr>
	</table>
</body>
<script type="text/javascript">
$(function(){
	var map = new BMap.Map("container",{
		mapType: BMAP_NORMAL_MAP,
		minZoom: 11,
		maxZoom:19
	});
	var currentPoint = new BMap.Point(121.423501,31.224045);
	map.centerAndZoom(currentPoint, 15);

	map.addControl(new BMap.NavigationControl());
	map.enableScrollWheelZoom();
	map.enableKeyboard();

	function showInfo(e){
		// console.log(e.point.lng + ", " + e.point.lat);
	}
	map.addEventListener("click", showInfo);

	var positions = [{
		name:'中国联通(龚华路营业厅)',
		address:'上海市浦东新区龚华路366号',
		point:[121.692542,31.267594]
	},{
		name:'中国联通(成山路营业厅)',
		address:'上海市浦东新区成山路462号',
		point:[121.512974,31.177527]
	},{
		name:'中国联通(田林营业厅)',
		address:'上海市徐汇区田林东路461号',
		point:[121.431637,31.178252]
	},{
		name:'中国联通(龙胜路营业厅)',
		address:'上海市金山区石化龙胜路563号-565号',
		point:[121.34441,30.730215],
		tel:'(021)60892022'
	},{
		name:'中国联通(广灵四路营业厅)',
		address:'上海市虹口区广灵四路322号',
		point:[121.479593,31.293187],
		tel:'(021)61428517'	
	},{
		name:'中国联通(淞虹路营业厅)',
		address:'上海市长宁区淞虹路148号',
		point:[121.368117,31.226557],
		tel:'(021)61242678'	
	},{
		name:'中国联通(长宁路营业厅)',
		address:'上海市长宁区长宁路1033号',
		point:[121.423501,31.224045],
		tel:''	
	}];

	$('#searchInput').keypress(function(event){
		if(event.keyCode == "13"){
			$('#searchBtn').click();
		}
	});

	$('#searchBtn').click(function(){
		for(var i=0;i<positions.length;i++){
			var position = positions[i];
			var keyWord = $('#searchInput').val();
			position.distance = null;
			if(position.name.indexOf(keyWord) != -1 || position.address.indexOf(keyWord) != -1){
				var point = new BMap.Point(position.point[0],position.point[1]);
				var distance = map.getDistance(currentPoint, point);
				position.distance = distance.toFixed(0);
			}
		}

		positions.sort(function(a, b){
			return a.distance - b.distance;
		});

		$('.position-box .points').empty();

		var messenger = new Messenger('mapChild');
		messenger.addTarget(window.parent, 'mapParent');

		for(var i=0;i<positions.length;i++){
			var position = positions[i];
			if(position.distance){
				var li = $(
					'<li class="point">'+
						'<span class="icon" style="background-position:0 -'+(25*i)+'px;"></span>'+
						'<div class="name">'+position.name+'</div>'+
						'<div class="item">'+
							'地址：'+position.address+'<br/>'+
							'电话：'+(position.tel||'暂无')+'<br/>'+
							'距离：'+position.distance+' 米'+
						'</div>'+
					'</li>'
				);

				(function(position, i, li){
					var point = new BMap.Point(position.point[0],position.point[1]);
					li.click(function(){
						// console.log(position)
						map.centerAndZoom(point, 15);
						$('.position-box .points .active').removeClass('active');
						li.addClass('active');
						document.domain = 'localhost.com';
						parent.parentMethod();
						messenger.targets['mapParent'].send(JSON.stringify(position));
					});

					var myIcon = new BMap.Icon("./images/markers.png", new BMap.Size(23, 25), {
						imageOffset: new BMap.Size(0, 0 - i * 25)
					});
					var marker = new BMap.Marker(point, {icon:myIcon});
					map.addOverlay(marker);
				})(position, i, li);

				$('.position-box .points').append(li);
			}
		}
	});

	$('#searchBtn').click();
});
</script>
</html>